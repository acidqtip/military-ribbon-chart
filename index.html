<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Military Ribbon Chart Application</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            background: #f9f9f9;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn:hover {
            background: #f0f0f0;
        }

        .tab-btn.active {
            color: #2a5298;
            border-bottom-color: #2a5298;
        }

        .tab-content {
            display: none;
            padding: 30px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        button {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(42, 82, 152, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .debug-panel h4 {
            margin-bottom: 10px;
            color: #2a5298;
        }

        .debug-log {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
            font-size: 11px;
        }

        .debug-log .success {
            color: #155724;
        }

        .debug-log .error {
            color: #721c24;
        }

        .debug-log .info {
            color: #004085;
        }

        .ribbon-chart {
            margin: 30px 0;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid #2a5298;
        }

        .ribbon-row {
            display: flex;
            align-items: center;
            margin: 20px 0;
            gap: 15px;
        }

        .year-label {
            min-width: 80px;
            font-weight: 600;
            color: #2a5298;
        }

        .ribbons {
            flex: 1;
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
        }

        .ribbon {
            height: 40px;
            min-width: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .ribbon:hover {
            transform: scaleY(1.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .ribbon-operational { background: linear-gradient(135deg, #1e90ff 0%, #0047ab 100%); }
        .ribbon-staff { background: linear-gradient(135deg, #ff6b6b 0%, #cc0000 100%); }
        .ribbon-command { background: linear-gradient(135deg, #ff8c00 0%, #ff4500 100%); }
        .ribbon-school { background: linear-gradient(135deg, #50c878 0%, #228b22 100%); }
        .ribbon-joint { background: linear-gradient(135deg, #9370db 0%, #663399 100%); }
        .ribbon-other { background: linear-gradient(135deg, #808080 0%, #505050 100%); }

        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
            z-index: 1000;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .ribbon:hover .tooltip {
            opacity: 1;
        }

        .assignment-details {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-left: 4px solid #2a5298;
            border-radius: 4px;
        }

        .assignment-details h4 {
            color: #2a5298;
            margin-bottom: 8px;
        }

        .assignment-details p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .info-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #f0f7ff;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #2a5298;
        }

        .info-card label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
        }

        .info-card .value {
            font-size: 18px;
            font-weight: 600;
            color: #2a5298;
            margin-top: 5px;
        }

        .database-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .database-card {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .database-card:hover {
            border-color: #2a5298;
            box-shadow: 0 5px 15px rgba(42, 82, 152, 0.2);
            transform: translateY(-3px);
        }

        .database-card h3 {
            color: #2a5298;
            margin-bottom: 10px;
        }

        .database-card p {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }

        .match-score {
            display: inline-block;
            background: #2a5298;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .delete-btn {
            background: #dc3545;
            padding: 6px 12px;
            font-size: 12px;
            margin-top: 10px;
        }

        .delete-btn:hover {
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }

        .upload-area {
            border: 2px dashed #2a5298;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f0f7ff;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #e6f0ff;
            border-color: #1e3c72;
        }

        .upload-area.dragover {
            background: #d4e6ff;
            border-color: #1e3c72;
        }

        .extraction-results {
            background: #f0f7ff;
            border-left: 5px solid #2a5298;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .extraction-results h3 {
            color: #2a5298;
            margin-bottom: 15px;
        }

        .assignment-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            background: white;
        }

        .assignment-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            line-height: 1.6;
        }

        .assignment-item:last-child {
            border-bottom: none;
        }

        .assignment-item strong {
            color: #2a5298;
        }

        .mentor-match {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #2a5298;
        }

        .mentor-match h4 {
            color: #2a5298;
            margin-bottom: 10px;
        }

        .mentor-match .match-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
            font-size: 13px;
        }

        .mentor-match .match-details p {
            margin: 5px 0;
        }

        .mentor-match .match-details strong {
            color: #2a5298;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéñÔ∏è Military Ribbon Chart Application</h1>
            <p>Career Planning & Mentor Matching System</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="create">Create Chart</button>
            <button class="tab-btn" data-tab="upload">Upload Biography</button>
            <button class="tab-btn" data-tab="database">Saved Charts</button>
            <button class="tab-btn" data-tab="matching">Mentor Matching</button>
        </div>

        <!-- CREATE CHART TAB -->
        <div id="create" class="tab-content active">
            <h2>Create Ribbon Chart</h2>
            
            <div class="debug-panel">
                <h4>üß™ Test Panel (Remove Before Shipping)</h4>
                <div style="margin-bottom: 10px;">
                    <button style="background: #007bff; font-size: 12px; padding: 8px 12px;" onclick="testTabSwitching()">Test Tab Switching</button>
                    <button style="background: #28a745; font-size: 12px; padding: 8px 12px; margin-left: 5px;" onclick="testAddAssignment()">Test Add Assignment</button>
                    <button style="background: #ffc107; font-size: 12px; padding: 8px 12px; margin-left: 5px; color: #333;" onclick="clearDebugLog()">Clear Log</button>
                </div>
                <div class="debug-log" id="debugLog">Debug messages will appear here...</div>
            </div>
            
            <div class="form-group">
                <label>Officer Information</label>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Rank</label>
                    <select id="rank">
                        <option>Second Lieutenant</option>
                        <option>First Lieutenant</option>
                        <option>Captain</option>
                        <option>Major</option>
                        <option>Lieutenant Colonel</option>
                        <option>Colonel</option>
                        <option>Brigadier General</option>
                        <option>Major General</option>
                        <option>Lieutenant General</option>
                        <option>General</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="officerName" placeholder="e.g., Matthew S. Cantore">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Year Group (Commission Year)</label>
                    <input type="number" id="yearGroup" placeholder="e.g., 1998" min="1940" max="2025">
                </div>
                <div class="form-group">
                    <label>AFSC (Air Force Specialty Code)</label>
                    <input type="text" id="afsc" placeholder="e.g., 11/12M MWS">
                </div>
            </div>

            <div class="form-group">
                <label>Add Assignment</label>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Start Date (YYYY-MM)</label>
                    <input type="month" id="assignmentStart">
                </div>
                <div class="form-group">
                    <label>End Date (YYYY-MM)</label>
                    <input type="month" id="assignmentEnd">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Assignment Title</label>
                    <input type="text" id="assignmentTitle" placeholder="e.g., Commander, 21st Operations Group">
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="assignmentType">
                        <option value="OPERATIONAL">Operational</option>
                        <option value="STAFF">Staff</option>
                        <option value="COMMAND">Command</option>
                        <option value="SCHOOL">School</option>
                        <option value="JOINT">Joint</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="assignmentLocation" placeholder="e.g., Peterson SFB, Colorado">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <input type="text" id="assignmentNotes" placeholder="Additional details">
                </div>
            </div>

            <button id="addAssignmentBtn">Add Assignment</button>
            <button class="btn-secondary" id="clearFormBtn">Clear</button>

            <div id="assignmentsList" style="margin-top: 30px;"></div>

            <div style="margin-top: 20px;">
                <button id="saveChartBtn" style="background: #28a745;">Save Chart to Database</button>
                <button class="btn-secondary" id="generateVizBtn">Generate Visualization</button>
            </div>

            <div id="ribbonChart"></div>
        </div>

        <!-- UPLOAD BIOGRAPHY TAB -->
        <div id="upload" class="tab-content">
            <h2>Upload Military Biography PDF</h2>
            
            <div class="upload-area" id="uploadArea" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <p style="font-size: 18px; margin-bottom: 10px;">üìÑ Drag & Drop PDF Here</p>
                <p style="color: #666; margin-bottom: 15px;">or click to select file</p>
                <input type="file" id="pdfFile" accept=".pdf" style="display: none;" onchange="handleFileSelect(event)">
                <button onclick="document.getElementById('pdfFile').click()" style="background: #2a5298;">Select PDF File</button>
            </div>

            <div id="uploadStatus"></div>
            <div id="extractionResults"></div>
        </div>

        <!-- DATABASE TAB -->
        <div id="database" class="tab-content">
            <h2>Saved Charts Database</h2>
            <p style="color: #666; margin-bottom: 20px;">All saved officer ribbon charts are stored below. Click to view or manage.</p>
            <div id="databaseGrid" class="database-grid"></div>
        </div>

        <!-- MENTOR MATCHING TAB -->
        <div id="matching" class="tab-content">
            <h2>Mentor Matching Algorithm</h2>
            
            <div class="form-group">
                <label>Search for Mentors by Career Aspiration</label>
                <input type="text" id="aspirationSearch" placeholder="e.g., Space Operations, Program Management, Joint Staff">
            </div>

            <button id="findMentorsBtn">Find Matching Mentors</button>

            <div id="matchingResults" style="margin-top: 30px;"></div>
        </div>
    </div>

    <script>
        // ============================================================
        // DEBUG UTILITIES
        // ============================================================
        function debugLog(message, type = 'info') {
            const log = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const entry = `<div class="${className}">[${timestamp}] ${message}</div>`;
            log.innerHTML += entry;
            log.scrollTop = log.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearDebugLog() {
            document.getElementById('debugLog').innerHTML = 'Debug messages will appear here...';
        }

        // ============================================================
        // TEST FUNCTIONS FOR BETA
        // ============================================================
        function testTabSwitching() {
            debugLog('üß™ Starting Tab Switching Test...', 'info');
            const tabs = ['create', 'upload', 'database', 'matching'];
            let testsPassed = 0;

            tabs.forEach(tabName => {
                try {
                    switchTab(tabName);
                    const activeTab = document.querySelector(`[data-tab="${tabName}"].active`);
                    const activeContent = document.getElementById(tabName).classList.contains('active');
                    
                    if (activeTab && activeContent) {
                        debugLog(`‚úì Tab "${tabName}" switched successfully`, 'success');
                        testsPassed++;
                    } else {
                        debugLog(`‚úó Tab "${tabName}" failed to switch`, 'error');
                    }
                } catch (e) {
                    debugLog(`‚úó Tab "${tabName}" error: ${e.message}`, 'error');
                }
            });

            debugLog(`Tab Test Complete: ${testsPassed}/${tabs.length} passed`, testsPassed === tabs.length ? 'success' : 'error');
        }

        function testAddAssignment() {
            debugLog('üß™ Starting Add Assignment Test...', 'info');
            try {
                // Set form values
                document.getElementById('assignmentStart').value = '2020-01';
                document.getElementById('assignmentEnd').value = '2021-06';
                document.getElementById('assignmentTitle').value = 'Test Commander';
                document.getElementById('assignmentType').value = 'COMMAND';
                document.getElementById('assignmentLocation').value = 'Peterson AFB';
                document.getElementById('assignmentNotes').value = 'Test Assignment';

                debugLog('Form values set', 'info');

                // Call addAssignment
                addAssignment();

                // Check if assignment was added
                if (currentChart.assignments.length > 0) {
                    debugLog(`‚úì Assignment added successfully (Total: ${currentChart.assignments.length})`, 'success');
                } else {
                    debugLog('‚úó Assignment was not added to chart', 'error');
                }
            } catch (e) {
                debugLog(`‚úó Add Assignment error: ${e.message}`, 'error');
            }
        }

        // ============================================================
        // CORE APPLICATION STATE
        // ============================================================
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let currentChart = {
            rank: '',
            name: '',
            yearGroup: '',
            afsc: '',
            assignments: []
        };

        let database = JSON.parse(localStorage.getItem('ribbonChartDB')) || [];

        // ============================================================
        // TAB SWITCHING - COMPLETELY REWRITTEN
        // ============================================================
        function switchTab(tabName) {
            debugLog(`Switching to tab: ${tabName}`, 'info');
            
            try {
                // Remove active from all tabs and buttons
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });

                // Add active to selected tab
                const tabElement = document.getElementById(tabName);
                if (!tabElement) {
                    throw new Error(`Tab element with id "${tabName}" not found`);
                }
                tabElement.classList.add('active');

                // Add active to button
                const btn = document.querySelector(`[data-tab="${tabName}"]`);
                if (!btn) {
                    throw new Error(`Button with data-tab="${tabName}" not found`);
                }
                btn.classList.add('active');

                // Render database if needed
                if (tabName === 'database') {
                    renderDatabase();
                }

                debugLog(`‚úì Successfully switched to ${tabName}`, 'success');
            } catch (e) {
                debugLog(`‚úó Error switching tab: ${e.message}`, 'error');
            }
        }

        // ============================================================
        // INITIALIZE TAB EVENT LISTENERS
        // ============================================================
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('üöÄ Application initialized', 'success');

            // Add tab button listeners
            const tabButtons = document.querySelectorAll('.tab-btn');
            debugLog(`Found ${tabButtons.length} tab buttons`, 'info');

            tabButtons.forEach((button, index) => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const tabName = this.getAttribute('data-tab');
                    debugLog(`Tab button ${index + 1} clicked (${tabName})`, 'info');
                    switchTab(tabName);
                });
            });

            // Add assignment button listener
            const addAssignmentBtn = document.getElementById('addAssignmentBtn');
            if (addAssignmentBtn) {
                addAssignmentBtn.addEventListener('click', function() {
                    debugLog('Add Assignment button clicked', 'info');
                    addAssignment();
                });
            }

            // Clear form button listener
            const clearFormBtn = document.getElementById('clearFormBtn');
            if (clearFormBtn) {
                clearFormBtn.addEventListener('click', function() {
                    debugLog('Clear Form button clicked', 'info');
                    clearForm();
                });
            }

            // Save chart button listener
            const saveChartBtn = document.getElementById('saveChartBtn');
            if (saveChartBtn) {
                saveChartBtn.addEventListener('click', function() {
                    debugLog('Save Chart button clicked', 'info');
                    saveChart();
                });
            }

            // Generate visualization button listener
            const generateVizBtn = document.getElementById('generateVizBtn');
            if (generateVizBtn) {
                generateVizBtn.addEventListener('click', function() {
                    debugLog('Generate Visualization button clicked', 'info');
                    generateVisualization();
                });
            }

            // Find mentors button listener
            const findMentorsBtn = document.getElementById('findMentorsBtn');
            if (findMentorsBtn) {
                findMentorsBtn.addEventListener('click', function() {
                    debugLog('Find Mentors button clicked', 'info');
                    findMentors();
                });
            }

            debugLog('‚úì All event listeners attached', 'success');
            initializeSampleData();
        });

        // ============================================================
        // ASSIGNMENT MANAGEMENT
        // ============================================================
        function addAssignment() {
            debugLog('addAssignment() called', 'info');

            const startDate = document.getElementById('assignmentStart').value;
            const endDate = document.getElementById('assignmentEnd').value;
            const title = document.getElementById('assignmentTitle').value;
            const type = document.getElementById('assignmentType').value;
            const location = document.getElementById('assignmentLocation').value;
            const notes = document.getElementById('assignmentNotes').value;

            debugLog(`Start: ${startDate}, Title: ${title}`, 'info');

            if (!startDate || !title) {
                debugLog('‚úó Validation failed: Missing startDate or title', 'error');
                alert('Please fill in start date and assignment title');
                return;
            }

            const assignment = {
                startDate: startDate,
                endDate: endDate,
                title: title,
                type: type,
                location: location,
                notes: notes
            };

            currentChart.assignments.push(assignment);
            debugLog(`‚úì Assignment added. Total assignments: ${currentChart.assignments.length}`, 'success');
            
            displayAssignmentsList();
            clearAssignmentForm();
        }

        function clearAssignmentForm() {
            document.getElementById('assignmentStart').value = '';
            document.getElementById('assignmentEnd').value = '';
            document.getElementById('assignmentTitle').value = '';
            document.getElementById('assignmentType').value = 'OPERATIONAL';
            document.getElementById('assignmentLocation').value = '';
            document.getElementById('assignmentNotes').value = '';
        }

        function clearForm() {
            currentChart = { rank: '', name: '', yearGroup: '', afsc: '', assignments: [] };
            document.getElementById('rank').value = 'Second Lieutenant';
            document.getElementById('officerName').value = '';
            document.getElementById('yearGroup').value = '';
            document.getElementById('afsc').value = '';
            document.getElementById('assignmentsList').innerHTML = '';
            document.getElementById('ribbonChart').innerHTML = '';
            clearAssignmentForm();
            debugLog('‚úì Form cleared', 'success');
        }

        function displayAssignmentsList() {
            const list = document.getElementById('assignmentsList');
            list.innerHTML = '<h3>Current Assignments:</h3>';

            currentChart.assignments.forEach((assignment, index) => {
                const startYear = assignment.startDate.split('-')[0];
                const endYear = assignment.endDate ? assignment.endDate.split('-')[0] : 'Present';
                
                list.innerHTML += `
                    <div class="assignment-details">
                        <h4>${assignment.title}</h4>
                        <p><strong>Duration:</strong> ${startYear} - ${endYear}</p>
                        <p><strong>Type:</strong> ${assignment.type}</p>
                        <p><strong>Location:</strong> ${assignment.location || 'Not specified'}</p>
                        ${assignment.notes ? `<p><strong>Notes:</strong> ${assignment.notes}</p>` : ''}
                        <button class="delete-btn" onclick="removeAssignment(${index})">Remove</button>
                    </div>
                `;
            });
        }

        function removeAssignment(index) {
            currentChart.assignments.splice(index, 1);
            debugLog(`‚úì Assignment removed. Total: ${currentChart.assignments.length}`, 'success');
            displayAssignmentsList();
        }

        // ============================================================
        // VISUALIZATION
        // ============================================================
        function generateVisualization() {
            debugLog('generateVisualization() called', 'info');

            if (currentChart.assignments.length === 0) {
                debugLog('‚úó No assignments to visualize', 'error');
                alert('No assignments to visualize');
                return;
            }

            const container = document.getElementById('ribbonChart');
            container.innerHTML = '<h3>Career Timeline Visualization</h3>';

            // Group assignments by year
            const yearMap = {};
            currentChart.assignments.forEach(assignment => {
                const startYear = assignment.startDate.split('-')[0];
                const endYear = assignment.endDate ? assignment.endDate.split('-')[0] : '2026';

                for (let year = parseInt(startYear); year <= parseInt(endYear); year++) {
                    if (!yearMap[year]) yearMap[year] = [];
                    yearMap[year].push(assignment);
                }
            });

            // Render timeline
            const sortedYears = Object.keys(yearMap).sort();
            const colorMap = {
                'OPERATIONAL': 'ribbon-operational',
                'STAFF': 'ribbon-staff',
                'COMMAND': 'ribbon-command',
                'SCHOOL': 'ribbon-school',
                'JOINT': 'ribbon-joint',
                'OTHER': 'ribbon-other'
            };

            sortedYears.forEach(year => {
                const assignmentsInYear = yearMap[year];
                let ribbonHtml = `<div class="ribbon-row"><span class="year-label">${year}</span><div class="ribbons">`;

                assignmentsInYear.forEach(assignment => {
                    const typeClass = colorMap[assignment.type] || 'ribbon-other';
                    ribbonHtml += `
                        <div class="ribbon ${typeClass}">
                            <div class="tooltip">${assignment.title}<br>${assignment.location}</div>
                        </div>
                    `;
                });

                ribbonHtml += '</div></div>';
                container.innerHTML += ribbonHtml;
            });

            // Add legend
            let legend = '<div style="margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;"><h4>Legend:</h4><div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 10px;">';
            Object.keys(colorMap).forEach(type => {
                legend += `<div><span class="ribbon ${colorMap[type]}" style="display: inline-block; width: 30px;"></span> ${type}</div>`;
            });
            legend += '</div></div>';
            container.innerHTML += legend;

            debugLog(`‚úì Visualization generated for ${sortedYears.length} years`, 'success');
        }

        // ============================================================
        // DATABASE MANAGEMENT
        // ============================================================
        function saveChart() {
            debugLog('saveChart() called', 'info');

            currentChart.rank = document.getElementById('rank').value;
            currentChart.name = document.getElementById('officerName').value;
            currentChart.yearGroup = document.getElementById('yearGroup').value;
            currentChart.afsc = document.getElementById('afsc').value;

            if (!currentChart.name || !currentChart.assignments.length) {
                debugLog('‚úó Validation failed: Missing name or assignments', 'error');
                alert('Please enter officer name and at least one assignment');
                return;
            }

            currentChart.id = Date.now();
            database.push(JSON.parse(JSON.stringify(currentChart)));
            localStorage.setItem('ribbonChartDB', JSON.stringify(database));

            debugLog(`‚úì Chart saved. Database size: ${database.length}`, 'success');
            alert('Chart saved successfully!');
            clearForm();
        }

        function renderDatabase() {
            debugLog(`renderDatabase() called - ${database.length} charts in database`, 'info');

            const grid = document.getElementById('databaseGrid');
            grid.innerHTML = '';

            if (database.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999; padding: 40px;">No charts saved yet</p>';
                return;
            }

            database.forEach(chart => {
                grid.innerHTML += `
                    <div class="database-card">
                        <h3>${chart.rank} ${chart.name}</h3>
                        <p><strong>Year Group:</strong> ${chart.yearGroup || 'Not specified'}</p>
                        <p><strong>AFSC:</strong> ${chart.afsc || 'Not specified'}</p>
                        <p><strong>Assignments:</strong> ${chart.assignments.length}</p>
                        <span class="match-score">‚úì Database Entry</span>
                        <button class="delete-btn" onclick="deleteChart(${chart.id})">Delete</button>
                    </div>
                `;
            });
        }

        function deleteChart(id) {
            if (confirm('Delete this chart?')) {
                database = database.filter(chart => chart.id !== id);
                localStorage.setItem('ribbonChartDB', JSON.stringify(database));
                debugLog(`‚úì Chart deleted. Database size: ${database.length}`, 'success');
                renderDatabase();
            }
        }

        // ============================================================
        // PDF UPLOAD & PARSING
        // ============================================================
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('uploadArea').classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect({ target: { files } });
            }
        }

        async function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;

            const file = files[0];
            const statusDiv = document.getElementById('uploadStatus');
            const resultsDiv = document.getElementById('extractionResults');

            statusDiv.innerHTML = '<div class="error-message">‚è≥ Processing PDF... This may take a moment.</div>';

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                let fullText = '';
                for (let i = 0; i < pdf.numPages; i++) {
                    const page = await pdf.getPage(i + 1);
                    const textContent = await page.getTextContent();
                    fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                }

                const extractedData = parseOfficerBiography(fullText);
                displayExtractionResults(extractedData, resultsDiv, statusDiv, file.name);

                window.lastExtractedData = extractedData;
                debugLog(`‚úì PDF processed: ${extractedData.assignments.length} assignments found`, 'success');

            } catch (error) {
                statusDiv.innerHTML = `<div class="error-message">‚ùå Error processing PDF: ${error.message}</div>`;
                debugLog(`‚úó PDF error: ${error.message}`, 'error');
            }
        }

        function normalizeWhitespace(text) {
            return text.replace(/\s+/g, ' ').trim();
        }

        function extractBiographyMetadata(bioText) {
            const result = { rank: '', name: '', afsc: '' };
            const headerLines = bioText.split('\n').slice(0, 3).join(' ');
            
            const rankPattern = /^(MAJOR GENERAL|LIEUTENANT GENERAL|BRIGADIER GENERAL|COLONEL|LIEUTENANT COLONEL|CAPTAIN|FIRST LIEUTENANT|SECOND LIEUTENANT)/i;
            const rankMatch = headerLines.match(rankPattern);
            if (rankMatch) {
                result.rank = rankMatch[1].toUpperCase();
            }
            
            if (result.rank) {
                const namePattern = new RegExp(`${result.rank}\\s+([A-Z][A-Za-z\\s\\.,'\\-]+?)(?:\\.|,|\\sis\\s)`, 'i');
                const nameMatch = headerLines.match(namePattern);
                if (nameMatch) {
                    let name = nameMatch[1].trim();
                    name = name.replace(/\b(?:Lt\.|Maj\.|Gen\.|BGen\.|Brig\.|Col\.|LtCol\.)\s+/gi, '');
                    const parts = name.split(/\s+/);
                    if (parts.length > 0) {
                        result.name = parts.slice(0, 3).join(' ').trim();
                    }
                }
            }
            
            const afscPattern = /AFSC[:\s]+([0-9A-Z\/\s]+)/i;
            const afscMatch = bioText.match(afscPattern);
            if (afscMatch) {
                result.afsc = afscMatch[1].trim().split('\n')[0];
            }
            
            return result;
        }

        function extractEducationInfo(eduText) {
            const degreePattern = /(\d{4})\s+(?:Bachelor|Master|Doctorate|Distinguished Graduate|Top Graduate|graduate)/i;
            const degreeMatch = eduText.match(degreePattern);
            if (degreeMatch) {
                const year = degreeMatch[1];
                if (year >= '1940' && year <= '2025') {
                    return year;
                }
            }
            
            const yearPattern = /(\d{4})/;
            const yearMatch = eduText.match(yearPattern);
            if (yearMatch) {
                const year = yearMatch[1];
                if (year >= '1940' && year <= '2025') {
                    return year;
                }
            }
            
            return '';
        }

        function parseAssignments(assignmentText) {
            const assignments = [];
            const normalizedText = normalizeWhitespace(assignmentText);
            const assignmentPattern = /^\s*(\d+)\.\s+(.+?)(?=^\s*\d+\.|$)/gms;
            let match;
            
            while ((match = assignmentPattern.exec(normalizedText)) !== null) {
                const assignmentLine = match[2].trim();
                const datePattern = /^([A-Za-z]+\s+\d{4})[\s\‚Äì\-‚àí‚Äì]+([A-Za-z]+\s+\d{4}|Present)(?:[,\s])/i;
                const dateMatch = assignmentLine.match(datePattern);
                
                if (dateMatch) {
                    const startDateStr = dateMatch[1];
                    const endDateStr = dateMatch[2];
                    
                    const startDate = convertDateToYYYYMM(startDateStr);
                    const endDate = endDateStr.toLowerCase() === 'present' ? '' : convertDateToYYYYMM(endDateStr);
                    
                    if (!startDate) continue;
                    
                    const remainingText = assignmentLine.substring(dateMatch[0].length).trim();
                    const parts = remainingText.split(/,\s*/).map(p => p.trim());
                    
                    let title = '';
                    let location = '';
                    let notes = '';
                    
                    if (parts.length >= 1) {
                        title = parts[0];
                    }
                    if (parts.length >= 2) {
                        location = parts.slice(1).join(', ');
                    }
                    
                    const parentPattern = /\(([^)]+)\)/;
                    const parentMatch = remainingText.match(parentPattern);
                    if (parentMatch) {
                        notes = parentMatch[1];
                    }
                    
                    const assignment = {
                        startDate: startDate,
                        endDate: endDate,
                        title: title || 'Assignment',
                        type: classifyAssignmentType(title),
                        location: location,
                        notes: notes
                    };
                    
                    assignments.push(assignment);
                }
            }
            
            return assignments;
        }

        function parseOfficerBiography(text) {
            const result = {
                rank: '',
                name: '',
                yearGroup: '',
                afsc: '',
                assignments: [],
                parseQuality: 'unknown'
            };

            const bioMatch = text.match(/BIOGRAPHY\s*\n+(.+?)(?=EDUCATION|ASSIGNMENTS|OTHER|$)/is);
            const bioText = bioMatch ? bioMatch[1] : '';
            
            const eduMatch = text.match(/EDUCATION\s*\n+(.+?)(?=ASSIGNMENTS|AWARDS|DECORATIONS|OTHER|$)/is);
            const eduText = eduMatch ? eduMatch[1] : '';
            
            const assignMatch = text.match(/ASSIGNMENTS\s*\n+(.+?)(?=SUMMARY OF|MAJOR AWARDS|EDUCATION|OTHER|MILITARY|$)/is);
            const assignText = assignMatch ? assignMatch[1] : '';

            if (bioText) {
                const bioMeta = extractBiographyMetadata(bioText);
                result.rank = bioMeta.rank;
                result.name = bioMeta.name;
                result.afsc = bioMeta.afsc;
            }

            if (eduText) {
                result.yearGroup = extractEducationInfo(eduText);
            }

            if (assignText) {
                result.assignments = parseAssignments(assignText);
                
                if (result.assignments.length > 20) {
                    result.parseQuality = 'excellent';
                } else if (result.assignments.length > 10) {
                    result.parseQuality = 'good';
                } else if (result.assignments.length > 3) {
                    result.parseQuality = 'fair';
                } else if (result.assignments.length > 0) {
                    result.parseQuality = 'poor';
                } else {
                    result.parseQuality = 'failed';
                }
            }

            return result;
        }

        function convertDateToYYYYMM(dateStr) {
            const months = {
                'january': '01', 'february': '02', 'march': '03', 'april': '04',
                'may': '05', 'june': '06', 'july': '07', 'august': '08',
                'september': '09', 'october': '10', 'november': '11', 'december': '12',
                'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04', 'may': '05',
                'jun': '06', 'jul': '07', 'aug': '08', 'sep': '09', 'oct': '10',
                'nov': '11', 'dec': '12'
            };

            const parts = dateStr.trim().split(/\s+/);
            if (parts.length === 2) {
                const month = months[parts[0].toLowerCase()];
                const year = parts[1];
                if (month && year) {
                    return `${year}-${month}`;
                }
            }
            return '';
        }

        function classifyAssignmentType(title) {
            const title_lower = title.toLowerCase();

            if (title_lower.includes('commander') || title_lower.includes('command')) return 'COMMAND';
            if (title_lower.includes('joint') || title_lower.includes('staff')) return 'JOINT';
            if (title_lower.includes('student') || title_lower.includes('course') || title_lower.includes('school')) return 'SCHOOL';
            if (title_lower.includes('chief') || title_lower.includes('director') || title_lower.includes('officer')) return 'STAFF';

            return 'OPERATIONAL';
        }

        function displayExtractionResults(data, resultsDiv, statusDiv, fileName) {
            let html = `<div class="extraction-results">`;
            html += `<h3>‚úì Successfully parsed ${fileName}</h3>`;

            html += `<div class="info-section" style="margin: 20px 0;">
                <div class="info-card">
                    <label>Rank</label>
                    <div class="value">${data.rank || 'Not detected'}</div>
                </div>
                <div class="info-card">
                    <label>Name</label>
                    <div class="value">${data.name || 'Not detected'}</div>
                </div>
                <div class="info-card">
                    <label>Year Group</label>
                    <div class="value">${data.yearGroup || 'Not detected'}</div>
                </div>
                <div class="info-card">
                    <label>AFSC</label>
                    <div class="value">${data.afsc || 'Not detected'}</div>
                </div>
            </div>`;

            html += `<h4>Detected Assignments (${data.assignments.length})</h4>`;
            html += `<div class="assignment-list">`;

            if (data.assignments.length > 0) {
                data.assignments.forEach((assignment, index) => {
                    html += `<div class="assignment-item">
                        <strong>${index + 1}. ${assignment.startDate} - ${assignment.endDate || 'Present'}</strong><br>
                        ${assignment.title}<br>
                        <em>${assignment.location}</em>
                    </div>`;
                });
            } else {
                html += `<p style="color: #999; text-align: center; padding: 20px;">No assignments detected. The PDF format may not be standard.</p>`;
            }

            html += `</div>`;
            html += `<button onclick="useExtractedData()" style="margin-top: 15px;">‚úì Use This Data</button>
                     <button class="btn-secondary" onclick="document.getElementById('pdfFile').click()">‚ü≤ Upload Different PDF</button>`;
            html += `</div>`;

            resultsDiv.innerHTML = html;
            statusDiv.innerHTML = `<div class="success-message">‚úì PDF extraction complete! Found ${data.assignments.length} assignments.</div>`;
        }

        function useExtractedData() {
            if (window.lastExtractedData) {
                const data = window.lastExtractedData;
                currentChart = JSON.parse(JSON.stringify(data));

                document.getElementById('rank').value = data.rank || 'Second Lieutenant';
                document.getElementById('officerName').value = data.name || '';
                document.getElementById('yearGroup').value = data.yearGroup || '';
                document.getElementById('afsc').value = data.afsc || '';

                displayAssignmentsList();
                generateVisualization();

                debugLog(`‚úì Extracted data loaded: ${data.assignments.length} assignments`, 'success');
                alert('Data loaded! Review and save to database when ready.');
            }
        }

        // ============================================================
        // MENTOR MATCHING
        // ============================================================
        function findMentors() {
            debugLog('findMentors() called', 'info');

            const aspiration = document.getElementById('aspirationSearch').value.toLowerCase();
            if (!aspiration) {
                debugLog('‚úó No aspiration entered', 'error');
                alert('Please enter a career aspiration to search');
                return;
            }

            const matchResults = [];

            database.forEach(potentialMentor => {
                let matchScore = 0;
                let matchReasons = [];

                potentialMentor.assignments.forEach(assignment => {
                    const titleLower = assignment.title.toLowerCase();
                    const locationLower = assignment.location.toLowerCase();

                    if (titleLower.includes('commander')) matchScore += 2;
                    if (titleLower.includes('director')) matchScore += 2;
                    if (titleLower.includes('chief')) matchScore += 1;

                    if (titleLower.includes(aspiration) || locationLower.includes(aspiration)) {
                        matchScore += 5;
                        matchReasons.push(`${assignment.title} at ${assignment.location}`);
                    }
                });

                const rankScore = { 'MAJOR GENERAL': 5, 'BRIGADIER GENERAL': 4, 'COLONEL': 3, 'LIEUTENANT COLONEL': 2 };
                const mentorRank = potentialMentor.rank || '';
                Object.keys(rankScore).forEach(rank => {
                    if (mentorRank.includes(rank)) matchScore += rankScore[rank];
                });

                if (matchScore > 0) {
                    matchResults.push({
                        mentor: potentialMentor,
                        score: matchScore,
                        reasons: matchReasons
                    });
                }
            });

            matchResults.sort((a, b) => b.score - a.score);

            const resultsDiv = document.getElementById('matchingResults');
            resultsDiv.innerHTML = '';

            if (matchResults.length === 0) {
                debugLog(`‚úó No mentors found for "${aspiration}"`, 'error');
                resultsDiv.innerHTML = `<div class="error-message">No mentors found matching "${aspiration}". Try adding more charts to the database.</div>`;
                return;
            }

            debugLog(`‚úì Found ${matchResults.length} mentors matching "${aspiration}"`, 'success');
            resultsDiv.innerHTML = `<h3>Found ${matchResults.length} Potential Mentor${matchResults.length !== 1 ? 's' : ''}</h3>`;

            matchResults.slice(0, 5).forEach(result => {
                const mentor = result.mentor;
                resultsDiv.innerHTML += `
                    <div class="mentor-match">
                        <h4>${mentor.rank} ${mentor.name}</h4>
                        <div class="match-details">
                            <div>
                                <p><strong>Match Score:</strong> ${result.score}%</p>
                                <p><strong>Year Group:</strong> ${mentor.yearGroup}</p>
                            </div>
                            <div>
                                <p><strong>AFSC:</strong> ${mentor.afsc}</p>
                                <p><strong>Total Experience:</strong> ${mentor.assignments.length} assignments</p>
                            </div>
                        </div>
                        ${result.reasons.length > 0 ? `<p style="margin-top: 10px; color: #666;"><strong>Relevant Experience:</strong> ${result.reasons.slice(0, 2).join(', ')}</p>` : ''}
                    </div>
                `;
            });
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================
        function initializeSampleData() {
            const sampleCharts = [
                {
                    id: Date.now(),
                    rank: "BRIGADIER GENERAL",
                    name: "Matthew S. Cantore",
                    yearGroup: "1998",
                    afsc: "13S000",
                    assignments: [
                        { startDate: "1999-05", endDate: "2000-05", title: "Crew Commander and Instructor", type: "OPERATIONAL", location: "Clear Air Force Station, Alaska", notes: "13th Space Warning Squadron" },
                        { startDate: "2000-08", endDate: "2003-08", title: "Flight Commander and Evaluator", type: "OPERATIONAL", location: "Minot AFB, North Dakota", notes: "741st Missile Squadron" },
                        { startDate: "2003-09", endDate: "2006-01", title: "ICBM Test Operations Officer", type: "OPERATIONAL", location: "Vandenberg AFB, California", notes: "576th Flight Test Squadron" },
                        { startDate: "2006-02", endDate: "2009-06", title: "Chief of Space Operations", type: "STAFF", location: "Shaw AFB, South Carolina", notes: "609th Air Operations Group" },
                        { startDate: "2013-06", endDate: "2015-02", title: "Commander", type: "COMMAND", location: "Schriever AFB, Colorado", notes: "3rd Space Experimentation Squadron" },
                        { startDate: "2019-05", endDate: "2020-07", title: "Commander", type: "COMMAND", location: "Peterson AFB, Colorado", notes: "21st Operations Group" }
                    ]
                }
            ];

            database = sampleCharts;
            localStorage.setItem('ribbonChartDB', JSON.stringify(database));
            debugLog('‚úì Sample data initialized', 'success');
        }
    </script>
</body>
</html>
